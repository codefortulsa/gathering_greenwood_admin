name: Deploy to Linode Production

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Linode Server
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Linode via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.LINODE_HOST }}
          username: ${{ secrets.LINODE_USER }}
          key: ${{ secrets.LINODE_SSH_KEY }}
          port: 5422
          script: |
            set -e

            echo "üöÄ Starting deployment to Linode Production..."
            echo "================================================"

            # Navigate to application directory
            cd /var/www/greenwood-kiosk

            # Show current state
            echo "üìç Current location: $(pwd)"
            echo "üìù Current commit: $(git log -1 --oneline)"

            # Fetch latest code
            echo ""
            echo "üì• Fetching latest code from GitHub..."
            sudo -u rails git fetch origin
            sudo -u rails git reset --hard origin/master

            echo "‚úÖ Updated to commit: $(git log -1 --oneline)"

            # Install Ruby dependencies
            echo ""
            echo "üíé Installing Ruby dependencies..."
            sudo -u rails bash -lc 'cd /var/www/greenwood-kiosk && bundle install --deployment --without development test'

            # Install JavaScript dependencies (if package.json changed)
            if git diff HEAD@{1} HEAD --name-only | grep -q "package.json\|yarn.lock"; then
              echo ""
              echo "üì¶ Installing JavaScript dependencies..."
              sudo -u rails bash -lc 'cd /var/www/greenwood-kiosk && yarn install --frozen-lockfile'
            else
              echo ""
              echo "‚è≠Ô∏è  Skipping JavaScript dependencies (no changes)"
            fi

            # Run database migrations
            echo ""
            echo "üóÑÔ∏è  Running database migrations..."
            sudo -u rails bash -lc 'cd /var/www/greenwood-kiosk && RAILS_ENV=production bundle exec rails db:migrate'

            # Precompile assets (if assets changed)
            if git diff HEAD@{1} HEAD --name-only | grep -q "app/assets\|app/javascript"; then
              echo ""
              echo "üé® Precompiling assets..."
              sudo -u rails bash -lc 'cd /var/www/greenwood-kiosk && RAILS_ENV=production bundle exec rails assets:precompile'
            else
              echo ""
              echo "‚è≠Ô∏è  Skipping asset precompilation (no changes)"
            fi

            # Restart Rails application
            echo ""
            echo "üîÑ Restarting Rails application..."
            sudo systemctl restart greenwood-admin.service

            # Wait a moment for service to start
            sleep 3

            # Check service status
            echo ""
            echo "üìä Service Status:"
            sudo systemctl status greenwood-admin.service --no-pager -l | head -20 || true

            # Check if service is running
            if sudo systemctl is-active --quiet greenwood-admin.service; then
              echo ""
              echo "‚úÖ Service is RUNNING"
            else
              echo ""
              echo "‚ùå WARNING: Service may not be running properly!"
              exit 1
            fi

            # Show recent logs
            echo ""
            echo "üìú Recent logs (last 10 lines):"
            sudo journalctl -u greenwood-admin.service -n 10 --no-pager || true

            echo ""
            echo "================================================"
            echo "üéâ Deployment completed successfully!"
            echo "================================================"

      - name: Notify on success
        if: success()
        run: |
          echo "‚úÖ Deployment to Linode successful!"
          echo "Deployed commit: ${{ github.sha }}"
          echo "By: ${{ github.actor }}"

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Deployment to Linode FAILED!"
          echo "Check the logs above for details"
          exit 1
